<%= tinymce_assets %>
<%= form_with model: project, url: url, remote: true, format: :js, method: :post, html: { class:'edit_student_project_form', id: "edit_student_project_form" } do |f| %>
<%= f.hidden_field :batch_id, value: batch_id %>
<div class='row' id="edit_student_project_upload">
  <div class='col-md-3'>
    <label>Học sinh <span style="color: red">*</span></label>
  </div>
  <% if current_user.is_teacher? %>
  <div class='col-md-8 project_detail_select'>
    <%= f.select :student_id, options_for_select(all_student, project.student_id), {} , { class: 'project_detail' } %>
  </div>
  <% elsif current_user.is_student? %>
  <div class='col-md-8'>
    <%= f.hidden_field :student_id, value: current_user.id %>
    <input type='text' readonly value="<%= current_user.op_student.full_name %>">
  </div>
  <% end %>
</div>
<div class='row' id="edit_student_project_subject">
  <div class='col-md-3'>
    <label>Học phần <span style="color: red">*</span></label>
  </div>
  <div class="col-md-8 project_detail_select">
    <%= f.select :subject_id, options_for_select(subjects, project.subject_id), {} , { class: 'project_detail', id: 'student_project_subject' }  %>
  </div>
</div>
<div class="project_name row">
  <div class='col-md-3'>
    <label><%= t('student_project.project_name') %> <span style='color: red'>*</span></label>
  </div>
  <div class='col-md-8'>
    <%= f.text_field :name, class: 'project_detail', placeholder: "#{ t('student_project.project_name') }" %>
  </div>
</div>
<div class='row'>
  <div class='col-md-12'>
    <label><%= t('student_project.description') %></label>
    <%= f.text_area :description, class: 'tinymce', :rows => 6 %>
    <%= tinymce :simple %>
  </div>
</div>
<div class='row' style='margin-top: 30px; margin-bottom: 0px; display: flex'>
  <div class='col-md-4 col-sm-4 col-xs-4' style="display: flex; flex-direction: column;">
    <div class='upload_layer upload_project_presentation'>
      <div class="upload_image ">
        <%= image_tag('global/images/microsoft-powerpoint.png') %>
      </div>
      <div class="upload_info">
        <%= f.hidden_field :change_presentation, id: "presentation_had_change", value: '0' %>
        <% if project.presentation.attached? %>
        <p style="font-size: 16px; font-weight: 700"><%= t('student_project.slide') %></p>
        <%= link_to image_tag('/global/images/downloadinvoice.png') + 'Click to download', rails_blob_path(project.presentation, disposition: "attachment"), id: "download-presentation", style: "font-size: 15px; font-weight: 700;" %>
        <p style="text-align: center; width: 100%" class='click_to_update'><%= t('student_project.click_to_update') %></p>
        <% else %>
        <p style="font-size: 16px; font-weight: 700"><%= t('student_project.slide') %></p>
        <p class="project_presentation_file_name" style="text-align: center"> <span class="project_presentation_state"><%= t('student_project.no_presentation') %></span> </p>
        <p class='click_to_update'><%= t('student_project.click_to_update') %></p>
        <% end %>
      </div>
    </div>
    <%= f.file_field :presentation, id: "upload_project_presentation" %>
  </div>
  <div class='col-md-4 col-sm-4 col-xs-4' style="display: flex; flex-direction: column;">
    <div class='upload_layer upload_project_video'>
      <% if project.introduction_video.present? %>
      <div id="project_video_name">
        <%= SocialCommunity::StudentProject::StudentProjectDecorator.new(project).youtube_embed_link.html_safe %>
      </div>
      <p class='click_to_update'><%= t('student_project.click_to_update') %></p>
      <% else %>
      <div class="upload_image">
        <%= image_tag('global/images/button-youtube.png', style: 'width: 40px') %>
      </div>
      <div class="upload_info">
        <p style="font-size: 16px; font-weight: 700;"><%= t('student_project.video') %></p>
        <p class="project_video_name_blank" style="text-align: center"> <span class="project_presentation_state"><%= t('student_project.no_video') %></span> </p>
        <p class='click_to_update'><%= t('student_project.click_to_update') %></p>
      </div>
      <% end %>
    </div>
    <%= f.file_field :introduction_video, id: "upload_project_video" %>
  </div>
  <div class='col-md-4 col-sm-4 col-xs-4' style="display: flex; flex-direction: column;">
    <div class='upload_layer upload_project_file'>
      <% if project.project_show_video.present? %>
      <div class="upload_image">
        <%= image_tag('global/images/browser.png') %>
      </div>
      <div class="upload_info">
        <%= f.text_field :project_show_video, class:"present_show_video", id: "upload_project_file", readonly: true %>
        <%= f.hidden_field :change_video, id: "video_had_change", value: '0' %>
        <p style="text-align: center; width: 100%; display: none;" class="no_link_file"> <span><%= t('student_project.no_link') %></span> </p>
        <p style="text-align: center; width: 100%"> <span class="project_presentation_state click_to_update"><%= t('student_project.click_to_update') %></span> </p>
      </div>
      <% else %>
      <div class="upload_image">
        <%= image_tag('global/images/browser.png') %>
      </div>
      <div class="upload_info">
        <label style="width: 100%; text-align: center"><%= t('student_project.link') %></label>
        <%= f.text_field :project_show_video, id: "upload_project_file", class:"blank_show_video" %>
        <p style="text-align: center; width: 100%"> <span class="no_link_file"><%= t('student_project.no_link') %></span> </p>
        <p style="text-align: center"> <span class="project_presentation_state click_to_update"><%= t('student_project.click_to_update') %></span> </p>
      </div>
      <% end %>
    </div>
  </div>
</div>
<div class='row'>
  <div class='col-md-4 col-sm-4'>
    <div class="progress progress-presentation">
      <div class="progress-bar progress-bar-warning progress-bar-striped" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%">
        PROGRESS
      </div>
    </div>
  </div>
  <div class="col-md-4 col-sm-4 progress progress-video" style='padding:0'>
    <div class="progress-bar progress-bar-warning progress-bar-striped" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%">
      PROGRESS
    </div>
  </div>
</div>
<div class="project_permission row" style="margin-top: 30px">
  <div class="col-md-12">
    <div style='float: right'>
    <div style="text-align: left">
      <%= f.check_box :permission, checked: true, value: 'public' %>
      <label for="permission"><%= t('student_project.public_html') %></label><br>
      <%= f.check_box :state, value: 'publish' %>
      <label for="state"><%= t('student_project.state_html') %></label><br>
    </div>
    </div>
  </div>
</div>
<% end %>
<style>
  .project_detail {
    width: 100%;
    margin-bottom: 10px;
  }

  .project_detail_select .project_detail {
    -webkit-appearance: none;
  }

  #edit_student_project_form select:hover {
    -webkit-appearance: auto;
  }

  #edit_student_project_form select {
    padding: 10px;
  }

  #edit_upload_project_subject:hover {
    -webkit-appearance: auto;
  }

  #edit_upload_project_subject {
    width: 100% !important;
    margin: 10px 0;
    padding: 5px 1px;
  }

  #edit_upload_project_student {
    width: 100% !important;
    padding: 5px 1px;
  }

  #edit_upload_project_student:hover {
    -webkit-appearance: auto;
  }

  .project_name {
    margin-bottom: 10px
  }

  .project_name input {
    padding: 10px
  }

  .upload_layer {
    display: flex;
    align-items: center;
    flex-direction: column;
    justify-content: center;
    flex: 1;
    background-color: #e3e3e3;
    padding: 20px;
  }

  .upload_image {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .upload_image img {
    width: 30%
  }

  #upload_project_video {
    display: none;
  }

  .blank_show_video {
    display: none;
  }

  .present_show_video {
    display: block;
  }

  #upload_project_presentation {
    display: none;
  }

  .upload_project_video iframe {
    width: 100%;
    height: 100%;
  }

  #upload_project_file {
    font-size: 16px;
    font-weight: 700;
    border: none;
    background-color: #e3e3e3;
  }

  .upload_project_file .upload_info {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }

  .upload_info p {
    text-align: center;
  }

  .progress {
    height: 20px;
    display: none;
    margin-top: 20px !important;
  }

  .progress div {
    line-height: 20px;
    font-size: 12px;
    height: 100%;
    font-weight: 700;
  }

  #download-presentation img {
    width: 20px;
  }

  .click_to_update {
    font-size: 14px;
    font-family: 'Monsterrat';
    font-weight: 600;
    text-decoration: underline;
    color: #5DC2A7;
    cursor: pointer;
  }
</style>
<script>
  $("#edit_video_infomation").ready(function() {
    subject_id = $('input[name="active_subject_project"]').val();
    $('#student_project_subject').val(subject_id);
    $('.project_detail_select').append('<span class="fa fa-caret-down" style="position: absolute; right: 30px; top: 30%"></span>');
    $('.upload_project_presentation').on('click', function(e) {
      if ((e.target !== this) && ($(e.target).is($('#download-presentation'))))
        return;

      $('#upload_project_presentation').trigger('click');
      $('#upload_project_presentation').on('change', function() {
        var ext = this.value.match(/\.(.+)$/)[1];
        if (['ppt', 'pptx', 'pdf'].includes(ext)) {
          if ($('#upload_project_presentation').get(0).files.length > 0) {
            $('#presentation_had_change').val('1');
            $('.project_presentation_file_name').html("<span style='font-size: 16px; font-weight: 600'>" + $('#upload_project_presentation')[0].files[0].name.substring(0, 20) + "...<span>")
          }
        } else {
          $('#upload_project_presentation').val('');
          alert('File không phù hợp! Chỉ hỗ trợ file đuôi "ppt", "pptx", "pdf"')
        };
      })
    })
    $('.upload_project_video').on('click', function(e) {
      $('#upload_project_video').trigger('click');
      $('#upload_project_video').on('change', function() {
        var ext = this.value.match(/\.(.+)$/)[1];
        if (['m4v', 'avi', 'mpg', 'mp4', 'webm'].includes(ext)) {
          $('#video_had_change').val('1');
          if ($('#upload_project_video').get(0).files.length > 0) {
            <% if project.introduction_video.present? %>
              html = '<div class="upload_image"><%= image_tag("global/images/button-youtube.png") %></div><div class="upload_info"><p style="font-size: 16px; font-weight: 700">Video giới thiệu về dự án</p><p id="project_video_name" style="text-align: center"><span class="project_presentation_state" style="font-size: 16px; font-weight: 600>">' + $('#upload_project_video')[0].files[0].name.substring(0, 20) + '...</span></p></div>'
            $('#project_video_name').html(html) 
            <% else %>
                $('.project_video_name_blank').html("<span style='font-size: 16px; font-weight: 600'>" + $('#upload_project_video')[0].files[0].name.substring(0, 20) + "...<span>") 
            <% end %>
          }
        } else {
          $('#upload_project_video').val('');
          alert('File không phù hợp! Chỉ hỗ trợ file đuôi "m4v", "avi","mpg","mp4", "webm"')
        }
      })
    })
    $('.upload_project_file').on('click', function() {
      $('#upload_project_file').data('val', $('#upload_project_file').val());
      $('#upload_project_file').show();
      $("#upload_project_file").attr("readonly", false);
      $('#upload_project_file').select();
      $('#upload_project_file').focus();
      $('.no_link_file').hide();
    })

    $('#upload_project_file').blur(function() {
      if ($('#upload_project_file').val().length === 0) {
        if ($('#upload_project_file').data('val').length > 0) {
          $('#upload_project_file').val($('#upload_project_file').data('val'));
        } else {
          $('#upload_project_file').hide();
          $('.no_link_file').show();
        }
      } else {
        $('#upload_project_file').show();
        $('.no_link_file').hide();
      }
    })
  })
</script>
